<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expedi√ß√£o Mobile</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

    <style>
        /* Vari√°veis Globais de Cor */
        :root {
            --primary: #00D4AA;
            --secondary: #00B4D8;
            --accent: #0077B6;
            --dark: #023047;
            --darker: #011627;
            --light: #90E0EF;
            --primary-gradient: linear-gradient(135deg, #00D4AA 0%, #00B4D8 50%, #0077B6 100%);
            --secondary-gradient: linear-gradient(135deg, #90E0EF 0%, #00D4AA 100%);
        }

        body {
            font-family: 'Inter', 'Segoe UI', -apple-system, sans-serif;
            background-color: #f4f7fa;
        }

        /* Tela de sele√ß√£o de filial */
        .filial-selection-container {
            background: var(--primary-gradient);
            min-height: 100vh;
            padding: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filial-selection {
            max-width: 400px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 16px 32px rgba(0, 119, 182, 0.2);
            padding: 30px 20px;
            text-align: center;
        }

        .filial-selection h2 {
            color: var(--dark);
            font-size: 1.8rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .filial-selection p {
            color: var(--secondary);
            font-size: 1rem;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .filial-card {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(0, 212, 170, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .filial-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(0, 212, 170, 0.3);
        }

        .filial-card h3 {
            color: var(--dark);
            font-size: 1.2rem;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .filial-card p {
            color: var(--secondary);
            font-size: 0.85rem;
            margin: 0;
        }

        .filial-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

        /* Header mobile */
        .mobile-header {
            background: var(--darker);
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .mobile-header h1 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mobile-header .filial-info {
            font-size: 0.8rem;
            color: var(--light);
            margin-top: 4px;
        }

        /* Navega√ß√£o bottom */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 8px 0;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 4px;
            color: #6b7280;
            text-decoration: none;
            transition: all 0.2s ease;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item i {
            margin-bottom: 4px;
        }

        /* Conte√∫do principal */
        .main-content {
            padding: 1rem;
            padding-bottom: 80px; /* Espa√ßo para bottom nav */
            max-width: 100%;
        }

        .view-content {
            display: none;
        }

        .view-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards e formul√°rios */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 119, 182, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(0, 212, 170, 0.3);
            border-radius: 8px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
        }

        /* Bot√µes */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #00D4AA, #00B4D8);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #D62828, #F77F00);
            color: white;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 0.8rem;
        }

        .btn:active {
            transform: translateY(1px);
        }

        /* Stats cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--primary-gradient);
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* Lista de expedi√ß√µes */
        .expedition-item {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary);
        }

        .expedition-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .expedition-title {
            font-weight: 700;
            color: var(--dark);
            font-size: 1rem;
            line-height: 1.2;
        }

        .expedition-time {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .expedition-details {
            font-size: 0.85rem;
            color: #4b5563;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .status-pendente { background-color: #fee2e2; color: #991b1b; }
        .status-aguardando_agrupamento { background-color: #fef3c7; color: #92400e; }
        .status-aguardando_doca { background-color: #e0e7ff; color: #3730a3; }
        .status-aguardando_veiculo { background-color: #e0e7ff; color: #3730a3; }
        .status-em_carregamento { background-color: #fef3c7; color: #92400e; }
        .status-carregado { background-color: #d1fae5; color: #065f46; }
        .status-aguardando_faturamento { background-color: #dbeafe; color: #1e40af; }
        .status-faturamento_iniciado { background-color: #fef3c7; color: #92400e; }
        .status-faturado { background-color: #d1fae5; color: #065f46; }
        .status-saiu_para_entrega { background-color: #cffafe; color: #0e7490; }
        .status-entregue { background-color: #f3f4f6; color: #4b5563; }
        .status-retornando_cd { background-color: #e5e7eb; color: #1f2937; }
        .status-cancelado { background-color: #fee2e2; color: #991b1b; }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--secondary);
        }

        .spinner {
            border: 3px solid rgba(0, 212, 170, 0.1);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notifica√ß√µes */
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            font-weight: 600;
            text-align: center;
            transform: translateY(-100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.error {
            background: #ef4444;
        }

        .notification.success {
            background: var(--primary);
        }

        .notification.info {
            background: var(--accent);
        }

        /* Badges especiais */
        .type-badge {
            background: #0077B6;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: bold;
            margin-left: 8px;
        }

        .urgency-badge {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: bold;
            margin-left: 4px;
        }

        .urgency-4h {
            background: #FCBF49;
            color: white;
        }

        .urgency-8h {
            background: #F77F00;
            color: white;
        }

        /* Filtros ativos */
        .filter-active {
            border-color: var(--primary) !important;
            background: rgba(0, 212, 170, 0.05) !important;
        }

        .spinning {
            animation: spin 1s linear infinite;
        }
        
        .carga-badge {
            background: #DBEAFE;
            color: #1E40AF;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: bold;
            margin-top: 4px;
        }

        /* Responsividade adicional */
        @media (max-width: 320px) {
            .main-content {
                padding: 0.5rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    
    <div id="filialSelectionContainer" class="filial-selection-container">
        <div class="filial-selection">
            <h2>Selecione a Filial</h2>
            <p>Escolha sua filial para continuar</p>
            <div id="filiaisGrid">
                </div>
        </div>
    </div>

    <div id="mainApp" style="display: none;">
        
        <header class="mobile-header">
            <h1>
                <i data-feather="truck" class="w-5 h-5"></i>
                Expedi√ß√£o Mobile
            </h1>
            <div class="filial-info" id="headerFilial">Filial: Carregando...</div>
        </header>

        <div class="main-content">
            
            <div id="lancamento" class="view-content active">
                <div class="card">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Lan√ßar Expedi√ß√£o</h2>
                    <p class="text-sm text-gray-500 mb-6 text-center">Data e hora ser√£o registradas automaticamente</p>
                    
                    <form id="expeditionForm">
                        <div class="form-group">
                            <label for="lojaSelect">Loja *</label>
                            <select id="lojaSelect" required>
                                <option value="">Selecione a loja</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="docaSelect">Doca de Prepara√ß√£o *</label>
                            <select id="docaSelect" required>
                                <option value="">Selecione a doca</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="liderSelect">L√≠der Respons√°vel *</label>
                            <select id="liderSelect" required>
                                <option value="">Selecione o l√≠der</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="numerosCargaInput">N√∫meros de Carga (separados por v√≠rgula)</label>
                            <input type="text" id="numerosCargaInput" placeholder="Ex: CG001, CG002, CG003">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label for="palletsInput">Pallets</label>
                                <input type="number" id="palletsInput" min="0" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="rolltrainersInput">RollTrainers</label>
                                <input type="number" id="rolltrainersInput" min="0" value="0" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="observacoes">Observa√ß√µes</label>
                            <textarea id="observacoes" placeholder="Observa√ß√µes opcionais..." rows="3"></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i data-feather="plus-circle" class="w-4 h-4" style="display: inline; margin-right: 8px;"></i>
                            Lan√ßar Expedi√ß√£o
                        </button>
                    </form>
                </div>
            </div>

            <div id="acompanhamento" class="view-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalExpedicoes">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #F77F00, #FCBF49);">
                        <div class="stat-number" id="pendentesCount">0</div>
                        <div class="stat-label">Pendentes</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #00D4AA, #00B4D8);">
                        <div class="stat-number" id="emAndamentoCount">0</div>
                        <div class="stat-label">Em Andamento</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #10B981, #34D399);">
                        <div class="stat-number" id="concluidasCount">0</div>
                        <div class="stat-label">Conclu√≠das Hoje</div>
                    </div>
                </div>

                <div class="card" style="padding: 16px;">
                    <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <i data-feather="filter" class="w-4 h-4"></i>
                        Filtros
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="filtroData" style="font-size: 0.8rem;">Data:</label>
                            <input type="date" id="filtroData" onchange="applyFilters()" style="padding: 8px 12px; font-size: 0.9rem;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="filtroStatus" style="font-size: 0.8rem;">Status:</label>
                            <select id="filtroStatus" onchange="applyFilters()" style="padding: 8px 12px; font-size: 0.9rem;">
                                <option value="">Todos</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="filtroBusca" style="font-size: 0.8rem;">Buscar:</label>
                            <input type="text" id="filtroBusca" placeholder="Loja, l√≠der, doca..." onkeyup="applyFilters()" style="padding: 8px 12px; font-size: 0.9rem;">
                        </div>
                        <button class="btn btn-primary btn-small" onclick="refreshExpeditions()" style="height: fit-content; padding: 8px 12px; font-size: 0.8rem;">
                            <i data-feather="refresh-cw" class="w-4 h-4" style="display: inline; margin-right: 4px;"></i>
                            Atualizar
                        </button>
                    </div>
                    
                    <div style="margin-top: 12px; text-align: center;">
                        <button class="btn btn-danger btn-small" onclick="clearFilters()" style="padding: 6px 16px; font-size: 0.75rem;">
                            Limpar Filtros
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="font-semibold text-gray-800 mb-4">Expedi√ß√µes</h3>
                    <div id="expeditionsList">
                        <div class="loading">
                            <div class="spinner"></div>
                            Carregando expedi√ß√µes...
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <nav class="bottom-nav">
            <a href="#lancamento" class="nav-item active" onclick="showView('lancamento', this)">
                <i data-feather="plus-circle" class="w-5 h-5"></i>
                <span>Lan√ßar</span>
            </a>
            <a href="#acompanhamento" class="nav-item" onclick="showView('acompanhamento', this)">
                <i data-feather="list" class="w-5 h-5"></i>
                <span>Acompanhar</span>
            </a>
            <a href="#trocar" class="nav-item" onclick="trocarFilial()">
                <i data-feather="repeat" class="w-5 h-5"></i>
                <span>Trocar Filial</span>
            </a>
        </nav>

    </div>

    <div id="notificationContainer"></div>

    <script>
        // Configura√ß√£o da API
        const SUPABASE_URL = 'https://owsoweqqttcmuuaohxke.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93c293ZXFxdHRjbXV1YW9oeGtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyMjQ5OTAsImV4cCI6MjA3MTgwMDk5MH0.Iee27SUOIkhMFvgDWXrW3C38DUuMr0MyVtR-NjF6FRk';
        const headers = {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json'
        };

        // Vari√°veis globais
        let selectedFilial = null;
        let lojas = [], docas = [], lideres = [], veiculos = [], motoristas = [];
        let allExpeditions = [];
        let filteredExpeditions = [];

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async () => {
            await loadFiliais();
            feather.replace();
            
            // Event listeners
            document.getElementById('expeditionForm').addEventListener('submit', handleLancarExpedicao);
        });

        // Fun√ß√£o para requisi√ß√µes ao Supabase
        async function supabaseRequest(endpoint, method = 'GET', data = null, includeFilialFilter = true) {
            let url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
            
            if (includeFilialFilter && selectedFilial && method === 'GET') {
                const separator = url.includes('?') ? '&' : '?';
                url += `${separator}filial=eq.${selectedFilial.nome}`;
            }
            
            const options = { method, headers: { ...headers } };
            
            if (data && (method === 'POST' || method === 'PATCH')) {
                if (includeFilialFilter && selectedFilial) {
                    if (Array.isArray(data)) {
                        data = data.map(item => ({ ...item, filial: selectedFilial.nome }));
                    } else {
                        data = { ...data, filial: selectedFilial.nome };
                    }
                }
                options.body = JSON.stringify(data);
                if (method !== 'DELETE') {
                    options.headers.Prefer = 'return=representation';
                }
            }
            
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${await response.text()}`);
                }
                return method === 'DELETE' ? null : await response.json();
            } catch (error) {
                console.error(`Erro na requisi√ß√£o: ${method} ${url}`, error);
                showNotification(`Erro: ${error.message}`, 'error');
                throw error;
            }
        }

        // Carregar filiais
        async function loadFiliais() {
            try {
                const filiaisData = await supabaseRequest('filiais?select=nome,descricao,ativo&ativo=eq.true&order=nome', 'GET', null, false);
                renderFiliais(filiaisData);
            } catch (error) {
                document.getElementById('filiaisGrid').innerHTML = '<p class="text-red-500 text-center">Erro ao carregar filiais.</p>';
            }
        }

        function renderFiliais(filiais) {
            const grid = document.getElementById('filiaisGrid');
            grid.innerHTML = '';
            
            filiais.forEach(filial => {
                const card = document.createElement('div');
                card.className = 'filial-card';
                card.onclick = () => selectFilial(filial);
                card.innerHTML = `
                    <h3>${filial.nome}</h3>
                    <p>${filial.descricao || 'Filial'}</p>
                `;
                grid.appendChild(card);
            });
        }

        // Selecionar filial
        async function selectFilial(filial) {
            selectedFilial = filial;
            document.getElementById('headerFilial').textContent = `Filial: ${selectedFilial.nome}`;
            
            // Esconder sele√ß√£o e mostrar app
            document.getElementById('filialSelectionContainer').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            showNotification(`Filial ${selectedFilial.nome} selecionada!`, 'success');
            
            // Carregar dados
            await loadAppData();
        }

        // Trocar filial
        function trocarFilial() {
            selectedFilial = null;
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('filialSelectionContainer').style.display = 'block';
        }

        // Carregar dados do app
        async function loadAppData() {
            try {
                const [lojasData, docasData, lideresData, veiculosData, motoristasData] = await Promise.all([
                    supabaseRequest('lojas?select=*&ativo=eq.true&order=codigo,nome'),
                    supabaseRequest('docas?ativo=eq.true&order=nome'),
                    supabaseRequest('lideres?ativo=eq.true&order=nome'),
                    supabaseRequest('veiculos?order=placa'),
                    supabaseRequest('motoristas?order=nome')
                ]);
                
                lojas = lojasData || [];
                docas = docasData || [];
                lideres = lideresData || [];
                veiculos = veiculosData || [];
                motoristas = motoristasData || [];
                
                populateSelects();
                
                // Definir data padr√£o para hoje nos filtros
                const hoje = new Date().toISOString().split('T')[0];
                const filtroData = document.getElementById('filtroData');
                if (filtroData) {
                    filtroData.value = hoje;
                }
                
                loadExpeditions();
                
            } catch (error) {
                showNotification('Erro ao carregar dados', 'error');
            }
        }

        // Preencher selects
        function populateSelects() {
            // Lojas - ordenar por c√≥digo e depois por nome
            const lojaSelect = document.getElementById('lojaSelect');
            lojaSelect.innerHTML = '<option value="">Selecione a loja</option>';
            
            const lojasOrdenadas = [...lojas].sort((a, b) => {
                // Primeiro ordena por c√≥digo
                const codigoCompare = (a.codigo || '').localeCompare(b.codigo || '', 'pt-BR', { numeric: true });
                if (codigoCompare !== 0) return codigoCompare;
                // Se os c√≥digos s√£o iguais, ordena por nome
                return (a.nome || '').localeCompare(b.nome || '', 'pt-BR');
            });
            
            lojasOrdenadas.forEach(loja => {
                lojaSelect.innerHTML += `<option value="${loja.id}">${loja.codigo} - ${loja.nome}</option>`;
            });

            // Docas - ordenar por nome
            const docaSelect = document.getElementById('docaSelect');
            docaSelect.innerHTML = '<option value="">Selecione a doca</option>';
            
            const docasOrdenadas = [...docas].sort((a, b) => {
                return (a.nome || '').localeCompare(b.nome || '', 'pt-BR');
            });
            
            docasOrdenadas.forEach(doca => {
                docaSelect.innerHTML += `<option value="${doca.id}">${doca.nome}</option>`;
            });

            // L√≠deres - ordenar por nome
            const liderSelect = document.getElementById('liderSelect');
            liderSelect.innerHTML = '<option value="">Selecione o l√≠der</option>';
            
            const lideresOrdenados = [...lideres].sort((a, b) => {
                return (a.nome || '').localeCompare(b.nome || '', 'pt-BR');
            });
            
            lideresOrdenados.forEach(lider => {
                liderSelect.innerHTML += `<option value="${lider.id}">${lider.nome}</option>`;
            });
        }

        // Lan√ßar expedi√ß√£o
        async function handleLancarExpedicao(e) {
            e.preventDefault();
            
            const lojaId = document.getElementById('lojaSelect').value;
            const docaId = document.getElementById('docaSelect').value;
            const liderId = document.getElementById('liderSelect').value;
            const numerosCargaInput = document.getElementById('numerosCargaInput').value.trim();
            const pallets = parseInt(document.getElementById('palletsInput').value) || 0;
            const rolltrainers = parseInt(document.getElementById('rolltrainersInput').value) || 0;
            const observacoes = document.getElementById('observacoes').value.trim();

            // Valida√ß√µes
            if (!lojaId || !docaId || !liderId) {
                showNotification('Preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }

            if (pallets === 0 && rolltrainers === 0) {
                showNotification('Informe ao menos uma quantidade (Pallets ou RollTrainers)!', 'error');
                return;
            }

            try {
                // Processar n√∫meros de carga
                let numerosCarga = [];
                if (numerosCargaInput) {
                    numerosCarga = numerosCargaInput.split(',').map(num => num.trim()).filter(num => num.length > 0);
                }

                // Criar expedi√ß√£o
                const expeditionData = {
                    data_hora: new Date().toISOString(),
                    lider_id: liderId,
                    doca_id: docaId,
                    status: 'aguardando_agrupamento',
                    observacoes: observacoes || null,
                    numeros_carga: numerosCarga.length > 0 ? numerosCarga : null
                };
                
                const expeditionResponse = await supabaseRequest('expeditions', 'POST', expeditionData);
                if (!expeditionResponse || expeditionResponse.length === 0) {
                    throw new Error("Falha ao criar expedi√ß√£o");
                }
                
                const newExpeditionId = expeditionResponse[0].id;

                // Criar item da expedi√ß√£o
                const itemData = {
                    expedition_id: newExpeditionId,
                    loja_id: lojaId,
                    pallets: pallets,
                    rolltrainers: rolltrainers,
                    status_descarga: 'pendente'
                };
                
                await supabaseRequest('expedition_items', 'POST', itemData);

                const lojaNome = lojas.find(l => l.id === lojaId)?.nome || 'Loja';
                showNotification(`Expedi√ß√£o para ${lojaNome} lan√ßada com sucesso!`, 'success');

                // Limpar formul√°rio
                document.getElementById('expeditionForm').reset();
                
                // Recarregar expedi√ß√µes se estiver na tela de acompanhamento
                if (document.getElementById('acompanhamento').classList.contains('active')) {
                    loadExpeditions();
                }

            } catch (error) {
                console.error('Erro ao lan√ßar expedi√ß√£o:', error);
                showNotification(`Erro ao lan√ßar expedi√ß√£o: ${error.message}`, 'error');
            }
        }

        // Carregar expedi√ß√µes
        async function loadExpeditions() {
            try {
                // Usar data do filtro ou hoje como padr√£o
                const filtroData = document.getElementById('filtroData')?.value;
                const dataConsulta = filtroData || new Date().toISOString().split('T')[0];
                
                const expeditions = await supabaseRequest(`expeditions?data_hora=gte.${dataConsulta}T00:00:00&data_hora=lte.${dataConsulta}T23:59:59&order=data_hora.desc`);
                const items = await supabaseRequest('expedition_items');
                
                // Combinar expedi√ß√µes com seus itens e determinar ordem de entrega
                allExpeditions = expeditions.map(exp => {
                    const expItems = items.filter(item => item.expedition_id === exp.id);
                    
                    // Determinar informa√ß√µes da expedi√ß√£o baseado no tipo
                    let expeditionInfo = {};
                    
                    if (expItems.length === 1) {
                        // Expedi√ß√£o individual - uma loja
                        const loja = lojas.find(l => l.id === expItems[0].loja_id);
                        expeditionInfo = {
                            tipo: 'individual',
                            loja_nome: loja ? `${loja.codigo} - ${loja.nome}` : 'N/A',
                            ordem_entrega: 1,
                            total_lojas: 1
                        };
                    } else if (expItems.length > 1) {
                        // Expedi√ß√£o agrupada - m√∫ltiplas lojas
                        const lojasNomes = expItems.map(item => {
                            const loja = lojas.find(l => l.id === item.loja_id);
                            return loja ? `${loja.codigo}` : 'N/A';
                        }).join(', ');
                        
                        expeditionInfo = {
                            tipo: 'agrupada',
                            loja_nome: `${expItems.length} lojas: ${lojasNomes}`,
                            ordem_entrega: 'M√∫ltiplas',
                            total_lojas: expItems.length
                        };
                    } else {
                        // Expedi√ß√£o sem itens
                        expeditionInfo = {
                            tipo: 'vazia',
                            loja_nome: 'Sem itens',
                            ordem_entrega: 0,
                            total_lojas: 0
                        };
                    }
                    
                    const lider = lideres.find(l => l.id === exp.lider_id);
                    const doca = docas.find(d => d.id === exp.doca_id);
                    
                    return {
                        ...exp,
                        ...expeditionInfo,
                        items: expItems,
                        lider_nome: lider ? lider.nome : 'N/A',
                        doca_nome: doca ? doca.nome : 'N/A',
                        total_pallets: expItems.reduce((sum, item) => sum + (item.pallets || 0), 0),
                        total_rolltrainers: expItems.reduce((sum, item) => sum + (item.rolltrainers || 0), 0)
                    };
                });

                // Popular filtro de status na primeira execu√ß√£o
                if (document.getElementById('filtroStatus').children.length <= 1) {
                    populateStatusFilter();
                }

                // Aplicar filtros
                applyFilters();

            } catch (error) {
                console.error('Erro ao carregar expedi√ß√µes:', error);
                document.getElementById('expeditionsList').innerHTML = '<p class="text-center text-red-500">Erro ao carregar expedi√ß√µes</p>';
            }
        }

        // Popular filtro de status
        function populateStatusFilter() {
            const filtroStatus = document.getElementById('filtroStatus');
            if (!filtroStatus) return;

            const statuses = [...new Set(allExpeditions.map(e => e.status))];
            
            // Manter op√ß√£o "Todos"
            const currentValue = filtroStatus.value;
            filtroStatus.innerHTML = '<option value="">Todos</option>';
            
            statuses.forEach(status => {
                filtroStatus.innerHTML += `<option value="${status}">${getStatusLabel(status)}</option>`;
            });
            
            // Restaurar valor selecionado se existir
            if (currentValue) {
                filtroStatus.value = currentValue;
            }
        }

        // Aplicar filtros
        function applyFilters() {
            const filtroStatus = document.getElementById('filtroStatus')?.value || '';
            const filtroBusca = document.getElementById('filtroBusca')?.value.toLowerCase() || '';
            
            filteredExpeditions = allExpeditions.filter(exp => {
                // Filtro por status
                if (filtroStatus && exp.status !== filtroStatus) {
                    return false;
                }
                
                // Filtro por busca
                if (filtroBusca) {
                    const searchableText = [
                        exp.loja_nome,
                        exp.lider_nome,
                        exp.doca_nome,
                        exp.observacoes || '',
                        exp.numeros_carga ? exp.numeros_carga.join(' ').toLowerCase() : ''
                    ].join(' ').toLowerCase();
                    
                    if (!searchableText.includes(filtroBusca)) {
                        return false;
                    }
                }
                
                return true;
            });

            highlightActiveFilters();
            updateStats();
            renderExpeditions();
        }

        // Limpar filtros
        function clearFilters() {
            // Definir data para hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('filtroData').value = hoje;
            document.getElementById('filtroStatus').value = '';
            document.getElementById('filtroBusca').value = '';
            
            // Recarregar dados e aplicar filtros
            loadExpeditions();
        }

        // Atualizar expedi√ß√µes (recarregar do servidor)
        function refreshExpeditions() {
            const refreshBtn = document.querySelector('[onclick="refreshExpeditions()"]');
            const refreshIcon = refreshBtn?.querySelector('i');
            
            if (refreshIcon) {
                refreshIcon.classList.add('spinning');
            }
            
            showNotification('Atualizando expedi√ß√µes...', 'info');
            
            loadExpeditions().finally(() => {
                if (refreshIcon) {
                    refreshIcon.classList.remove('spinning');
                }
            });
        }

        // Destacar filtros ativos
        function highlightActiveFilters() {
            const filtroStatus = document.getElementById('filtroStatus');
            const filtroBusca = document.getElementById('filtroBusca');
            const filtroData = document.getElementById('filtroData');
            const hoje = new Date().toISOString().split('T')[0];
            
            // Destacar se h√° filtros ativos
            if (filtroStatus?.value) {
                filtroStatus.classList.add('filter-active');
            } else {
                filtroStatus?.classList.remove('filter-active');
            }
            
            if (filtroBusca?.value) {
                filtroBusca.classList.add('filter-active');
            } else {
                filtroBusca?.classList.remove('filter-active');
            }
            
            if (filtroData?.value && filtroData.value !== hoje) {
                filtroData.classList.add('filter-active');
            } else {
                filtroData?.classList.remove('filter-active');
            }
        }

        // Atualizar estat√≠sticas
        function updateStats() {
            const expeditionsToCount = filteredExpeditions.length > 0 ? filteredExpeditions : allExpeditions;
            
            const total = expeditionsToCount.length;
            const pendentes = expeditionsToCount.filter(e => ['aguardando_agrupamento', 'aguardando_veiculo'].includes(e.status)).length;
            const emAndamento = expeditionsToCount.filter(e => ['em_carregamento', 'carregado', 'saiu_para_entrega'].includes(e.status)).length;
            const concluidas = expeditionsToCount.filter(e => e.status === 'entregue').length;

            document.getElementById('totalExpedicoes').textContent = total;
            document.getElementById('pendentesCount').textContent = pendentes;
            document.getElementById('emAndamentoCount').textContent = emAndamento;
            document.getElementById('concluidasCount').textContent = concluidas;
        }

        // Renderizar expedi√ß√µes
        function renderExpeditions() {
            const container = document.getElementById('expeditionsList');
            const expeditionsToRender = filteredExpeditions.length > 0 || (document.getElementById('filtroStatus')?.value || document.getElementById('filtroBusca')?.value) ? filteredExpeditions : allExpeditions;
            
            if (expeditionsToRender.length === 0) {
                const hasFilters = document.getElementById('filtroStatus')?.value || document.getElementById('filtroBusca')?.value;
                const message = hasFilters ? 'Nenhuma expedi√ß√£o encontrada para os filtros aplicados' : 'Nenhuma expedi√ß√£o encontrada para esta data';
                container.innerHTML = `<p class="text-center text-gray-500">${message}</p>`;
                return;
            }

            container.innerHTML = expeditionsToRender.map(exp => {
                // Informa√ß√µes da doca
                const doca = docas.find(d => d.id === exp.doca_id);
                const docaInfo = doca ? doca.nome : 'N/A';
                
                // Determinar informa√ß√µes do ve√≠culo/motorista se alocado
                let veiculoInfo = '';
                if (exp.veiculo_id && exp.motorista_id) {
                    const veiculo = veiculos.find(v => v.id === exp.veiculo_id);
                    const motorista = motoristas.find(m => m.id === exp.motorista_id);
                    const placaVeiculo = veiculo ? veiculo.placa : 'N/A';
                    const nomeMotorista = motorista ? motorista.nome : 'N/A';
                    veiculoInfo = `<br><strong>üöö ${placaVeiculo}</strong> - ${nomeMotorista}`;
                } else if (exp.veiculo_id || exp.motorista_id) {
                    veiculoInfo = `<br><strong>üöõ Transporte:</strong> Em aloca√ß√£o...`;
                }
                
                // Criar detalhes da ordem de entrega
                let ordemInfo = '';
                if (exp.tipo === 'individual') {
                    ordemInfo = `<br><strong>üìç Ordem:</strong> Entrega √∫nica`;
                } else if (exp.tipo === 'agrupada') {
                    // Para expedi√ß√µes agrupadas, mostrar as lojas em ordem
                    const lojasOrdem = exp.items
                        .sort((a, b) => {
                            // Ordenar por data de cria√ß√£o ou por ID como fallback
                            const dateA = new Date(a.created_at || a.data_criacao || 0);
                            const dateB = new Date(b.created_at || b.data_criacao || 0);
                            if (dateA.getTime() === dateB.getTime()) {
                                return parseInt(a.id) - parseInt(b.id); // Fallback para ID
                            }
                            return dateA - dateB;
                        })
                        .map((item, index) => {
                            const loja = lojas.find(l => l.id === item.loja_id);
                            const statusIcon = getStatusIcon(item.status_descarga || 'pendente');
                            return `${statusIcon}${index + 1}¬∫ ${loja ? loja.codigo : 'N/A'}`;
                        }).join(' ‚Üí ');
                    ordemInfo = `<br><strong>üìç Roteiro:</strong> ${lojasOrdem}`;
                }
                
                // Badge de tipo de expedi√ß√£o
                let tipoBadge = '';
                if (exp.tipo === 'agrupada') {
                    tipoBadge = `<span class="type-badge">ROTA</span>`;
                }

                // Badge para n√∫meros de carga
                const numerosCargaBadge = exp.numeros_carga && exp.numeros_carga.length > 0
                    ? `<div class="carga-badge">Cargas: ${exp.numeros_carga.join(', ')}</div>`
                    : '';

                // Indicador de urg√™ncia baseado no tempo
                let urgencyBadge = '';
                const horasDecorridas = (new Date() - new Date(exp.data_hora)) / (1000 * 60 * 60);
                if (horasDecorridas > 8 && !['entregue', 'cancelado'].includes(exp.status)) {
                    urgencyBadge = `<span class="urgency-badge urgency-8h">‚è∞ +8h</span>`;
                } else if (horasDecorridas > 4 && !['entregue', 'cancelado'].includes(exp.status)) {
                    urgencyBadge = `<span class="urgency-badge urgency-4h">‚è∞ +4h</span>`;
                }

                return `
                    <div class="expedition-item">
                        <div class="expedition-header">
                            <div>
                                <div class="expedition-title">
                                    ${exp.loja_nome}${tipoBadge}${urgencyBadge}
                                </div>
                                <div class="expedition-time">${new Date(exp.data_hora).toLocaleString('pt-BR')}</div>
                            </div>
                            <span class="status-badge status-${exp.status}">${getStatusLabel(exp.status)}</span>
                        </div>
                        <div class="expedition-details">
                            <strong>‚öì Doca:</strong> ${docaInfo}${ordemInfo}<br>
                            <strong>üë§ L√≠der:</strong> ${exp.lider_nome}<br>
                            <strong>üì¶ Carga:</strong> ${exp.total_pallets}P + ${exp.total_rolltrainers}R${veiculoInfo}
                            ${exp.observacoes ? `<br><strong>üí¨ Obs:</strong> ${exp.observacoes}` : ''}
                            ${numerosCargaBadge}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Obter √≠cone do status da descarga
        function getStatusIcon(statusDescarga) {
            const icons = {
                'pendente': '‚è≥',
                'em_descarga': 'üöö',
                'descarregado': '‚úÖ',
                'cancelado': '‚ùå'
            };
            return icons[statusDescarga] || '‚è≥';
        }

        // Obter label do status
        function getStatusLabel(status) {
            const labels = {
                'pendente': 'Pendente',
                'aguardando_agrupamento': 'Aguard. Agrupamento',
                'aguardando_doca': 'Aguard. Doca',
                'aguardando_veiculo': 'Aguard. Ve√≠culo',
                'em_carregamento': 'Carregando',
                'carregado': 'Carregado',
                'aguardando_faturamento': 'Aguard. Faturamento',
                'faturamento_iniciado': 'Faturando',
                'faturado': 'Faturado',
                'saiu_para_entrega': 'Em Entrega',
                'entregue': 'Entregue',
                'retornando_cd': 'Retornando',
                'cancelado': 'Cancelado'
            };
            return labels[status] || status.replace(/_/g, ' ');
        }

        // Navega√ß√£o entre views
        function showView(viewId, element) {
            // Remover classe active de todas as views
            document.querySelectorAll('.view-content').forEach(view => {
                view.classList.remove('active');
            });
            
            // Remover classe active de todos os nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Ativar view e nav item
            document.getElementById(viewId).classList.add('active');
            if (element) element.classList.add('active');

            // Carregar dados espec√≠ficos da view
            if (viewId === 'acompanhamento') {
                loadExpeditions();
            }

            // Atualizar √≠cones
            feather.replace();
        }

        // Sistema de notifica√ß√µes
        function showNotification(message, type = 'success') {
            // Remover notifica√ß√£o existente
            const existing = document.getElementById('currentNotification');
            if (existing) {
                existing.remove();
            }

            // Criar nova notifica√ß√£o
            const notification = document.createElement('div');
            notification.id = 'currentNotification';
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.getElementById('notificationContainer').appendChild(notification);

            // Mostrar notifica√ß√£o
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Esconder ap√≥s 3 segundos
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Auto-refresh das expedi√ß√µes a cada 60 segundos quando na tela de acompanhamento
        setInterval(() => {
            if (document.getElementById('acompanhamento').classList.contains('active') && selectedFilial) {
                // Recarregar dados silenciosamente
                loadExpeditions();
            }
        }, 60000);

    </script>
</body>
</html>
